# Arca Distribution Guide

This guide covers creating releases, building distribution packages, and publishing Arca releases on GitHub.

## Prerequisites

### Required Tools

- **Xcode 16.0+** with Command Line Tools
- **Apple Developer ID Certificate** (optional, for code signing and notarization)
- **GitHub CLI** (`gh`) - For publishing releases
- **Go 1.24+** - For building vminit extensions

### Apple Developer Account (Optional)

Code signing and notarization are optional but recommended for public distribution.

**Developer ID Application Certificate**:
- Used to sign binaries for distribution outside the Mac App Store
- Certificate name: `Developer ID Application: Your Name (TEAM_ID)`
- Install via Apple Developer portal

**Notarization**:
- Requires Apple Developer account
- Uses `xcrun notarytool` for submission
- Store credentials: `xcrun notarytool store-credentials`

## Build Process

### 1. Build Pre-Built Assets

Assets must be built before creating the DMG installer.

```bash
# Build kernel and vminit (~20-25 minutes)
make build-assets

# Verify assets
ls -lh assets/
# Should show:
#   vmlinux-arm64.gz (~15 MB)
#   vminit-oci-arm64.tar.gz (~120 MB)
#   SHA256SUMS

# Verify checksums
cd assets && shasum -a 256 -c SHA256SUMS && cd ..
```

### 2. Build DMG Installer

```bash
# Set version (optional, defaults to git-derived version)
export VERSION=v0.2.0-alpha

# Set code signing identity (optional)
export CODESIGN_IDENTITY="Developer ID Application: Your Name (TEAM_ID)"

# Build DMG
make dist-dmg
```

**Output**: `dist/arca-{VERSION}.dmg`

**DMG Contents**:
- `Arca.app` - Native macOS GUI application
  - GUI app for status and control
  - Embedded Arca daemon binary
  - Pre-built kernel (vmlinux)
  - Pre-built vminit runtime (encrypted)
- `Applications` symlink for drag-and-drop installation

**DMG Size**: ~200 MB

### 3. Notarize DMG (Optional)

Notarization allows the DMG to be opened without Gatekeeper warnings.

```bash
# Submit for notarization (~5-15 minutes)
make notarize

# Or manually
./scripts/notarize.sh dist/arca-{VERSION}.dmg
```

**Requirements**:
- DMG must be code signed
- Apple Developer account credentials configured
- `xcrun notarytool` credentials stored

**Verification**:
```bash
# Verify notarization ticket is stapled
xcrun stapler validate dist/arca-{VERSION}.dmg

# Verify Gatekeeper acceptance
spctl -a -vv -t install dist/arca-{VERSION}.dmg
```

## Publishing Releases

### Using make publish (Recommended)

The `make publish` target automates the entire release process.

```bash
# Tag the release
git tag v0.2.0-alpha
git push origin v0.2.0-alpha

# Build and publish to GitHub
make publish
```

**What it does**:
1. Builds the DMG via `make dist-dmg`
2. Validates version doesn't contain 'dirty'
3. Generates SHA256 checksum
4. Creates GitHub draft release
5. Uploads DMG and checksum
6. Provides URL to review release

**Manual publish**:
1. Visit GitHub releases page (URL provided)
2. Edit release notes
3. Publish release when ready

### Manual GitHub Release

```bash
# Create release with GitHub CLI
gh release create v0.2.0-alpha \
  --title "Arca v0.2.0-alpha" \
  --notes "Release notes here" \
  --draft \
  dist/arca-v0.2.0-alpha.dmg
```

**Release Assets**:
- `arca-{VERSION}.dmg` - Main installer (required)
- `arca-{VERSION}.dmg.sha256` - Checksum (auto-generated by `make publish`)

## Testing Distribution

### Test Installation

```bash
# Mount DMG
open dist/arca-{VERSION}.dmg

# Drag Arca.app to /Applications
# Double-click Arca.app to launch

# Verify daemon is running
export DOCKER_HOST=unix://~/.arca/arca.sock
docker version
docker run hello-world
```

### Test on Clean System

Test in a clean macOS environment (VM or fresh user account):

```bash
# Install
open dist/arca-{VERSION}.dmg
# Drag to Applications, launch Arca.app

# Configure shell
export DOCKER_HOST=unix://~/.arca/arca.sock
echo 'export DOCKER_HOST=unix://~/.arca/arca.sock' >> ~/.zshrc

# Test basic functionality
docker run -d nginx
docker ps
docker stop $(docker ps -q)
```

## Release Checklist

### Pre-Release

- Build and verify pre-built assets (`make build-assets`)
- Verify checksums (`cd assets && shasum -a 256 -c SHA256SUMS`)
- Test kernel and vminit locally
- Commit all changes and ensure clean working tree

### Build

- Set `CODESIGN_IDENTITY` (if signing)
- Build DMG (`make dist-dmg`)
- Verify DMG mounts and contains Arca.app
- Test installation locally

### Notarize (Optional)

- Submit for notarization (`make notarize`)
- Wait for approval (~5-15 minutes)
- Verify stapled ticket
- Test Gatekeeper acceptance

### Publish

- Create git tag (`git tag v0.2.0-alpha`)
- Push tag (`git push origin v0.2.0-alpha`)
- Publish release (`make publish`)
- Edit release notes on GitHub
- Publish draft release
- Test download URL

### Post-Release

- Test installation from GitHub release
- Verify DMG opens without warnings (if notarized)
- Update documentation if needed

## Troubleshooting

### Code Signing Issues

**Error: "No identity found"**
```bash
# List available identities
security find-identity -v -p codesigning

# Install certificates from Apple Developer portal if empty
```

**Error: "Resource fork, Finder information, or similar detritus not allowed"**
```bash
# Clean extended attributes
xattr -cr .build/release/Arca
make dist-dmg
```

### DMG Creation Issues

**Error: "assets not found"**
- Verify assets exist: `ls -l assets/vmlinux-arm64.gz assets/vminit-oci-arm64.tar.gz`
- Rebuild assets: `make build-assets`

**Error: "GUI app build failed"**
- Check Xcode is installed: `xcode-select -p`
- Verify Swift toolchain: `swift --version`

### Notarization Issues

**Error: "The binary is not signed"**
- Set `CODESIGN_IDENTITY` environment variable
- Rebuild DMG: `make dist-dmg`

**Error: "Invalid notarization credentials"**
```bash
# Test credentials
xcrun notarytool history --keychain-profile "AC_PASSWORD"
```

### GitHub Release Issues

**Error: "gh not found"**
```bash
# Install GitHub CLI
brew install gh

# Authenticate
gh auth login
```

**Error: "dirty version"**
- Commit all changes: `git status`
- Ensure working tree is clean
- Rebuild with clean version tag

## Version Numbering

Arca uses semantic versioning with development stage identifiers:

- **Alpha**: `v0.1.0-alpha`, `v0.2.0-alpha` - Early development, unstable API
- **Beta**: `v0.9.0-beta`, `v1.0.0-beta.1` - Feature complete, stabilizing
- **Release Candidate**: `v1.0.0-rc.1` - Production ready, final testing
- **Stable**: `v1.0.0`, `v1.1.0` - Production releases

Example workflow:
```bash
# Alpha release
git tag v0.2.0-alpha
make publish

# Beta release
git tag v0.9.0-beta
make publish

# Stable release
git tag v1.0.0
make publish
```
